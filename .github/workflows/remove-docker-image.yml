name: Delete Docker image on release deletion

on:
  release:
    types: [deleted]

jobs:
  delete_from_registry:
    name: Delete Docker image from Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Delete Docker image digest
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          IMAGE_NAME: ${{ vars.DOCKER_IMAGE }}
          TAG_TO_DELETE: ${{ github.event.release.tag_name }}
        run: |
          # Extract namespace and repository from IMAGE_NAME
          NAMESPACE=$(echo $IMAGE_NAME | cut -d'/' -f1)
          REPOSITORY=$(echo $IMAGE_NAME | cut -d'/' -f2)

          echo "Authenticating with Docker Hub..."
          TOKEN=$(curl -s -H "Content-Type: application/json" \
            -X POST \
            -d '{"username": "'"$DOCKER_USERNAME"'", "password": "'"$DOCKER_PASSWORD"'"}' \
            https://hub.docker.com/v2/users/login/ | jq -r .token)

          echo "Fetching digest for tag '$TAG_TO_DELETE'..."
          DIGEST=$(curl -s \
            -H "Authorization: JWT $TOKEN" \
            "https://hub.docker.com/v2/repositories/$NAMESPACE/$REPOSITORY/tags/$TAG_TO_DELETE/" | jq -r '.images[0].digest')

          if [ -z "$DIGEST" ] || [ "$DIGEST" == "null" ]; then
            echo "Digest not found for tag '$TAG_TO_DELETE'. Exiting."
            exit 1
          fi

          echo "Digest for tag '$TAG_TO_DELETE' is '$DIGEST'"

          echo "Deleting digest '$DIGEST' from repository '$NAMESPACE/$REPOSITORY'..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: JWT $TOKEN" \
            -X DELETE \
            "https://hub.docker.com/v2/repositories/$NAMESPACE/$REPOSITORY/digests/$DIGEST/")

          if [ "$RESPONSE" -eq 202 ]; then
            echo "Digest '$DIGEST' deleted successfully."
          else
            echo "Failed to delete digest '$DIGEST'. HTTP response code: $RESPONSE"
            exit 1
          fi
